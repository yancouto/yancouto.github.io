<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Metrodle Storage Bridge</title>
    <style>html, body {
        margin: 0;
        padding: 0;
        background: #fff;
        color: #000
    }</style>
</head>
<body>
<script>
    (function () {
        // This file is served under both hosts. For migration it must be loaded from
        // https://yancouto.github.io/storage-bridge.html so it can read the old
        // origin's localStorage, then postMessage it to the parent window.

        function safeGet(storage, key) {
            try {
                return storage.getItem(key);
            } catch {
                return null;
            }
        }

        async function ensureStorageAccess() {
            try {
                // Storage Access API (partitioned third-party storage â†’ request first-party access)
                if (typeof document.hasStorageAccess === 'function') {
                    var has = await document.hasStorageAccess();
                    if(has) return window.localStorage;
                    if (!has && typeof document.requestStorageAccess === 'function') {
                        try {
                            const handle = await document.requestStorageAccess({localStorage: true});
                            return handle.localStorage;
                        } catch {
                            // request denied or not supported
                        }
                    }
                }
            } catch {
                // ignore
            }
        }

        async function handleMessage(ev) {
            try {
                var data = ev.data || {};
                if (!data || (data.type !== 'metrodlesp:migration:request')) return;

                // For migration requests, first try to acquire storage access, then read keys
                const storage = await ensureStorageAccess();

                var payload = {
                    type: 'metrodlesp:migration:response',
                    keys: {
                        'metrodlesp:state': safeGet(storage, 'metrodlesp:state'),
                        'metrodlesp:stats': safeGet(storage, 'metrodlesp:stats'),
                        'seenHelpV1': safeGet(storage, 'seenHelpV1')
                    }
                };
                // Reply to the source; use * so it works across domains. The parent should validate the origin.
                ev.source && ev.source.postMessage(payload, '*');
            } catch (e) {
                // Best effort; do nothing on error
            }
        }

        window.addEventListener('message', handleMessage);
        // Also proactively announce readiness so the parent can know it's loaded
        try {
            parent && parent.postMessage({type: 'metrodlesp:migration:ready'}, '*');
        } catch {}
    })();
</script>
</body>
</html>
